# A script to fetch new content.
# Run this using bin/fetch

set -xe

cd ./content

# TODO: Fetch only if not fetched in last 30 minutes or so, to avoid API rate limit.
wget https://old.reddit.com/r/TheMotte/.json -O TheMotte.json

# Filter out relevant data
cat TheMotte.json | jq '.data.children | map (select (.data.title | contains("Culture War Roundup"))) | first' > CWR-meta.json
cat TheMotte.json | jq '.data.children | map (select (.data.title | contains("Wellness Wednesday for"))) | first' > WW-meta.json

# Get the original threads
CWR_JSON_URL="$(cat CWR-meta.json | jq -r .data.url).json?limit=20&depth=1"
wget $CWR_JSON_URL -O CWR.json
WW_JSON_URL="$(cat WW-meta.json | jq -r .data.url).json?limit=20&depth=1"
wget $WW_JSON_URL -O WW.json

# Clean up
# - Ignore dist==1 which is the submission text.
cat CWR.json \
        | jq 'map (select (.data.dist != 1)) | first' \
        | jq '.data.children' \
        | jq 'map(select (.data.author != "AutoModerator" and .kind == "t1") | {kind: .kind, id: .data.id, author: .data.author, score: .data.score, createdUtc: .data.created_utc, body: .data.body, permalink: .data.permalink})' \
        > CWR-sanitizied.json

cat WW.json \
        | jq 'map (select (.data.dist != 1)) | first' \
        | jq '.data.children' \
        | jq 'map(select (.data.author != "AutoModerator" and .kind == "t1") | {kind: .kind, id: .data.id, author: .data.author, score: .data.score, createdUtc: .data.created_utc, body: .data.body, permalink: .data.permalink})' \
        > WW-sanitizied.json